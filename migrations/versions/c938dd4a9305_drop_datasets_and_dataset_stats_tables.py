"""drop datasets and dataset_stats tables

Revision ID: c938dd4a9305
Revises: a097b34894c1
Create Date: 2019-10-07 13:38:12.721366

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'c938dd4a9305'
down_revision = 'a097b34894c1'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index('ix_dataset_stats_dataset_id', table_name='dataset_stats')
    op.drop_index('ix_dataset_stats_files', table_name='dataset_stats')
    op.drop_index('ix_dataset_stats_num_downloads', table_name='dataset_stats')
    op.drop_index('ix_dataset_stats_num_likes', table_name='dataset_stats')
    op.drop_index('ix_dataset_stats_num_subjects', table_name='dataset_stats')
    op.drop_index('ix_dataset_stats_num_views', table_name='dataset_stats')
    op.drop_index('ix_dataset_stats_size', table_name='dataset_stats')
    op.drop_index('ix_dataset_stats_sources', table_name='dataset_stats')
    op.drop_table('dataset_stats')
    op.drop_index('ix_datasets_annex_uuid', table_name='datasets')
    op.drop_index('ix_datasets_category', table_name='datasets')
    op.drop_index('ix_datasets_dataset_id', table_name='datasets')
    op.drop_index('ix_datasets_description', table_name='datasets')
    op.drop_index('ix_datasets_download_path', table_name='datasets')
    op.drop_index('ix_datasets_format', table_name='datasets')
    op.drop_index('ix_datasets_is_private', table_name='datasets')
    op.drop_index('ix_datasets_modality', table_name='datasets')
    op.drop_index('ix_datasets_name', table_name='datasets')
    op.drop_index('ix_datasets_owner_id', table_name='datasets')
    op.drop_index('ix_datasets_raw_data_url', table_name='datasets')
    op.drop_index('ix_datasets_version', table_name='datasets')
    op.drop_table('datasets')
    # ### end Alembic commands ###

    op.execute('ALTER TABLE newdatasets RENAME TO datasets')


def downgrade():
    op.execute('ALTER TABLE datasets RENAME TO newdatasets')

    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('datasets',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('dataset_id', sa.VARCHAR(length=64), nullable=True),
    sa.Column('annex_uuid', sa.VARCHAR(length=64), nullable=True),
    sa.Column('description', sa.TEXT(), nullable=True),
    sa.Column('owner_id', sa.INTEGER(), nullable=True),
    sa.Column('download_path', sa.VARCHAR(length=64), nullable=True),
    sa.Column('raw_data_url', sa.VARCHAR(length=128), nullable=True),
    sa.Column('image', sa.BLOB(), nullable=True),
    sa.Column('name', sa.VARCHAR(length=256), nullable=True),
    sa.Column('modality', sa.VARCHAR(length=64), nullable=True),
    sa.Column('version', sa.VARCHAR(length=6), nullable=True),
    sa.Column('format', sa.VARCHAR(length=64), nullable=True),
    sa.Column('category', sa.VARCHAR(length=64), nullable=True),
    sa.Column('date_created', sa.DATETIME(), nullable=False),
    sa.Column('date_updated', sa.DATETIME(), nullable=False),
    sa.Column('is_private', sa.BOOLEAN(), nullable=True),
    sa.CheckConstraint('is_private IN (0, 1)'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_datasets_version', 'datasets', ['version'], unique=False)
    op.create_index('ix_datasets_raw_data_url', 'datasets', ['raw_data_url'], unique=False)
    op.create_index('ix_datasets_owner_id', 'datasets', ['owner_id'], unique=False)
    op.create_index('ix_datasets_name', 'datasets', ['name'], unique=False)
    op.create_index('ix_datasets_modality', 'datasets', ['modality'], unique=False)
    op.create_index('ix_datasets_is_private', 'datasets', ['is_private'], unique=False)
    op.create_index('ix_datasets_format', 'datasets', ['format'], unique=False)
    op.create_index('ix_datasets_download_path', 'datasets', ['download_path'], unique=False)
    op.create_index('ix_datasets_description', 'datasets', ['description'], unique=False)
    op.create_index('ix_datasets_dataset_id', 'datasets', ['dataset_id'], unique=1)
    op.create_index('ix_datasets_category', 'datasets', ['category'], unique=False)
    op.create_index('ix_datasets_annex_uuid', 'datasets', ['annex_uuid'], unique=1)

    op.execute('INSERT INTO datasets SELECT id, dataset_id, annex_uuid, description, owner_id, download_path, raw_data_url, image, name, modality, version, format, category, date_created, date_updated, is_private FROM newdatasets')

    op.create_table('dataset_stats',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('dataset_id', sa.VARCHAR(length=64), nullable=True),
    sa.Column('size', sa.INTEGER(), nullable=True),
    sa.Column('files', sa.INTEGER(), nullable=True),
    sa.Column('sources', sa.INTEGER(), nullable=True),
    sa.Column('num_subjects', sa.INTEGER(), nullable=True),
    sa.Column('num_downloads', sa.INTEGER(), nullable=True),
    sa.Column('num_likes', sa.INTEGER(), nullable=True),
    sa.Column('num_views', sa.INTEGER(), nullable=True),
    sa.Column('date_updated', sa.DATETIME(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_dataset_stats_sources', 'dataset_stats', ['sources'], unique=False)
    op.create_index('ix_dataset_stats_size', 'dataset_stats', ['size'], unique=False)
    op.create_index('ix_dataset_stats_num_views', 'dataset_stats', ['num_views'], unique=False)
    op.create_index('ix_dataset_stats_num_subjects', 'dataset_stats', ['num_subjects'], unique=False)
    op.create_index('ix_dataset_stats_num_likes', 'dataset_stats', ['num_likes'], unique=False)
    op.create_index('ix_dataset_stats_num_downloads', 'dataset_stats', ['num_downloads'], unique=False)
    op.create_index('ix_dataset_stats_files', 'dataset_stats', ['files'], unique=False)
    op.create_index('ix_dataset_stats_dataset_id', 'dataset_stats', ['dataset_id'], unique=1)

    op.execute('INSERT INTO dataset_stats SELECT id, dataset_id, size, files, sources, num_subjects, num_downloads, num_likes, num_views, date_updated FROM newdatasets')
    # ### end Alembic commands ###
